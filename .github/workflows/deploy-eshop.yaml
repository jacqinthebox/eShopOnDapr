name: deploy-eshop

# Only trigger, when the infrastructure deployment succeeded
on:
  workflow_run:
    workflows: ["helm-ci"]
    types:
      - completed
  workflow_dispatch:
  push:
    branches:
    - main

    paths:
    - .github/workflows/deploy-eshop.yaml

env:
  ENVIRONMENT: kube-dev #TODO
  ACR_NAME: demo01cr
  ESHOP_NAMESPACE: eshop

jobs:
  deploy-to-aks:
    runs-on: ubuntu-latest
    steps:
    - name: Azure Kubernetes set context
      uses: Azure/aks-set-context@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }} #TODO
        resource-group: ${{ env.ENVIRONMENT }}-cluster-rg
        cluster-name: ${{ env.ENVIRONMENT }}-cluster

    - name: Helm tool installer
      uses: Azure/setup-helm@v1

    - name: Azure Login
      uses: Azure/login@v1.1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: login to acr using helm
      run: |
        echo $ | helm registry login  ${{ env.ACR_NAME }}.azurecr.io --username ${{ secrets.USERNAME }} --password ${{ secrets.PASSWORD }}
    
    #TODO: please check
    - name: deploy eshop
      run: |
        # echo $ | apt-get update && apt-get install jq
        echo $ | registryToken=$(az acr login --name ${{ secrets.REGISTRY_ENDPOINT }} --expose-token | jq -r '.accessToken')
        echo $(registryToken) | helm registry login ${{ secrets.REGISTRY_ENDPOINT }} -u 00000000-0000-0000-0000-000000000000 --password-stdin
        echo $ | helm repo add eshop oci://demo01cr.azurecr.io/helm/eshopondapr
        echo $ | helm upgrade --install eshop eshop --namespace ${{ env.ESHOP_NAMESPACE }}

