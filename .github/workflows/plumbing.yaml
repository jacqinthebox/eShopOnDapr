name: plumbing

# Only trigger, when the infrastructure deployment succeeded
on:
  # workflow_run:
  #   workflows: ["kube-dev-cluster"]
  #   types:
  #     - completed
  workflow_dispatch:
  push:
    branches:
    - main

    paths:
    - .github/workflows/plumbing.yaml

env:
  ENVIRONMENT: kube-dev #TODO

jobs:
  deploy-to-aks:
    runs-on: ubuntu-latest
    steps:
    - name: Azure Kubernetes set context
      uses: Azure/aks-set-context@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        resource-group: ${{ env.ENVIRONMENT }}-cluster-rg
        cluster-name: ${{ env.ENVIRONMENT }}-cluster

    - name: Get code from the repository
      uses: actions/checkout@v1
      with:
        ref: main

    - name: Helm tool installer
      uses: Azure/setup-helm@v1

    - name: Azure Login
      uses: Azure/login@v1.1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ingress-controller
      run: |
        echo $ | helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
        echo $ | helm repo update
        exho $ | helm install eshop-new ingress-nginx/ingress-nginx  --namespace kube-ingress --create-namespace
    
    - name: dapr
      run: |
        echo $ | wget -q https://raw.githubusercontent.com/dapr/cli/master/install/install.sh -O - | /bin/bash
        echo $ | dapr init -k
          
    - name: cert-manager
      run: |
        echo $ | kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.8.0/cert-manager.yaml
        echo $ | kubectl apply -f './deploy/cert-manager/staging-issuer.yaml'
        echo $ | kubectl apply -f './deploy/cert-manager/prod-issuer.yaml'